<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>323 instant noodle social</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { margin:0; background:#111; color:#fff; font-family:'Inter',sans-serif; display:flex; flex-direction:column; align-items:center; }
  .card { background:rgba(20,20,20,0.85); border-radius:24px; padding:24px; margin:40px auto; max-width:700px; width:100%; box-shadow:0 0 25px rgba(0,255,204,.4); }
  .title { font-size:28px; font-weight:800; color:#00ffcc; margin-bottom:8px; }
  .brand { font-size:20px; font-weight:600; color:#fff; margin-bottom:12px; }
  .desc { font-size:16px; line-height:1.6; color:#eee; margin:12px 0; }
  #hashtags { margin:12px 0; }
  .badge { display:inline-block; margin:4px; padding:6px 12px; background:linear-gradient(135deg,#ff00ff,#00ffff); border-radius:20px; font-size:13px; font-weight:bold; color:#000; text-transform:lowercase; box-shadow:0 0 12px rgba(255,0,255,.6); }
  #social-btn { background:linear-gradient(90deg,#ff00ff,#00ffff); color:#000; font-size:16px; font-weight:bold; padding:10px 20px; border:none; border-radius:20px; cursor:pointer; margin:10px 0; box-shadow:0 0 15px rgba(255,0,255,.6); text-transform:lowercase; }
  .panel { font-family:monospace; background:#111; border-radius:16px; padding:12px; max-height:200px; overflow:auto; border:1px solid #222; font-size:18px; color:#0ff; width:100%; box-sizing:border-box; }
  #chat-input { border:none; padding:12px; margin-top:8px; font-size:18px; width:100%; border-radius:8px; outline:none; }
  .chat-msg { margin:6px 0; font-size:18px; line-height:1.6; }
  .chat-user { color:#00ffcc; font-weight:bold; font-size:18px; }
  img.drop-img { width:100%; border-radius:16px; margin-top:12px; display:none; }
  @keyframes spin { from {transform:rotate(0deg);} to {transform:rotate(360deg);} }
</style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading" style="
    display:none; 
    position:fixed; top:0; left:0; right:0; bottom:0; 
    background:rgba(0,0,0,0.85); 
    display:flex; justify-content:center; align-items:center; flex-direction:column;
    font-family:'Inter',sans-serif; z-index:9999;">
    <div class="spinner" style="
      border:6px solid #222; border-top:6px solid #00ffcc; border-radius:50%;
      width:60px; height:60px; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
    <div style="color:#00ffcc; font-size:20px; font-weight:bold; text-transform:lowercase;">
      searching323kbabe...
    </div>
  </div>

  <section class="card">
    <div class="title" id="r-title">‚Äî</div>
    <div class="brand" id="r-artist">‚Äî</div>
    <p class="desc" id="r-desc">‚Äî</p>
    <div id="hashtags"></div>
    <img id="r-img" class="drop-img" alt="trend image" />
    <div id="r-fallback" style="color:#aaa; border:2px dashed #333; border-radius:16px; padding:12px; text-align:center; font-style:italic; margin-top:12px;">
      no image yet
    </div>

    <button id="social-btn">323 instant noodle social</button>

    <!-- Chat -->
    <div id="chat-container" style="display:none;">
      <div class="panel" id="chat-box"></div>
      <input id="chat-input" placeholder="type a message‚Ä¶" />
    </div>

    <!-- Console -->
    <div class="panel" id="log"></div>
  </section>

<script>
// --- Auto-generate private room ---
const urlParams = new URLSearchParams(window.location.search);
if (!urlParams.has("room")) {
  const newRoom = Math.random().toString(36).substring(2, 8);
  window.location.href = window.location.pathname + "?room=" + newRoom;
}
const roomId = urlParams.get("room");

// --- Connect to backend ---
const socket = io();
const user = "323-noodle-" + Math.floor(100 + Math.random()*900);
socket.emit("joinRoom", roomId);

// log box
const logEl=document.getElementById("log");
function log(msg){ const p=document.createElement("p"); p.textContent=msg; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }

// UI
const t=document.getElementById("r-title"),
      a=document.getElementById("r-artist"),
      d=document.getElementById("r-desc"),
      hashtags=document.getElementById("hashtags"),
      img=document.getElementById("r-img"),
      fb=document.getElementById("r-fallback"),
      chatBox=document.getElementById("chat-box"),
      input=document.getElementById("chat-input"),
      chatContainer=document.getElementById("chat-container"),
      socialBtn=document.getElementById("social-btn");

const voicePlayer = new Audio();
let chatMode = false;

// --- Fetch synced drop (room-aware, pre-gen) ---
async function loadDrop(){
  try{
    document.getElementById("loading").style.display="flex";
    const r=await fetch(`/api/trend?room=${roomId}`,{cache:"no-store"});
    const j=await r.json();

    t.textContent = j.product || "‚Äî";
    a.textContent = j.brand || "‚Äî";
    d.textContent = j.description || "‚Äî";
    hashtags.innerHTML = (j.hashtags||[]).map(x=>`<span class="badge">${x}</span>`).join("");

    if(j.image){ img.src=j.image; img.style.display="block"; fb.style.display="none"; }
    else { img.style.display="none"; fb.style.display="block"; }

    if(j.voice){ voicePlayer.src = j.voice; voicePlayer.play(); }

    setTimeout(loadDrop, j.refresh || 30000); // auto-refresh feed

  }catch(e){ log("‚ùå error fetching drop"); }
  finally { document.getElementById("loading").style.display="none"; }
}

// --- Open chat ---
function openChat() {
  socialBtn.style.display = "none";
  chatContainer.style.display = "block";
  chatMode = true;
  log(`üçú joined 323 instant noodle social ‚Äî room ${roomId}`);
}
socialBtn.addEventListener("click", openChat);
if (roomId) { openChat(); }

// --- Send chat ---
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && input.value.trim()!==""){
    const text=input.value.trim();
    socket.emit("chatMessage",{roomId,user,text});
    input.value="";
  }
});

// --- Receive chat ---
socket.on("chatMessage",async ({user:textUser,text})=>{
  const msg=document.createElement("div");
  msg.className="chat-msg";
  msg.innerHTML=`<span class="chat-user">${textUser}:</span> ${text}`;
  chatBox.appendChild(msg);
  chatBox.scrollTop=chatBox.scrollHeight;

  if(chatMode){
    voicePlayer.pause(); voicePlayer.currentTime=0;
    try{
      const r=await fetch(`/api/voice?text=${encodeURIComponent(textUser+" says "+text)}`);
      const blob=await r.blob();
      const voiceData=URL.createObjectURL(blob);
      voicePlayer.src = voiceData;
      voicePlayer.play();
    }catch(e){ log("‚ùå chat voice error"); }
  }
});

// start
loadDrop();
</script>
</body>
</html>
