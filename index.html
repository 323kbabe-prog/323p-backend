<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>323 instant noodle social</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { margin:0; background:#111; color:#fff; font-family:'Inter',sans-serif; display:flex; flex-direction:column; align-items:center; }
  .card { background:rgba(20,20,20,0.8); border-radius:24px; padding:24px; margin:40px auto; max-width:600px; width:100%; box-shadow:0 0 25px rgba(0,255,204,.4); }
  .title { font-size:26px; font-weight:800; color:#00ffcc; }
  .artist { font-size:20px; font-weight:600; color:#fff; }
  .desc { margin:1em 0; font-size:15px; line-height:1.5; color:#eee; }
  #social-btn { background:linear-gradient(90deg,#ff00ff,#00ffff); color:#000; font-size:16px; font-weight:bold; padding:10px 20px; border:none; border-radius:20px; cursor:pointer; margin:10px 0; }
  .panel { font-family:monospace; background:#111; border-radius:16px; padding:12px; max-height:200px; overflow:auto; border:1px solid #222; font-size:13px; color:#0ff; width:100%; box-sizing:border-box; }
  #chat-input { border:none; padding:8px; margin-top:6px; font-size:14px; width:100%; border-radius:8px; outline:none; }
  .chat-msg { margin:4px 0; }
  .chat-user { color:#00ffcc; font-weight:bold; }
</style>
</head>
<body>
  <section class="card">
    <div class="title" id="r-title">â€”</div>
    <div class="artist" id="r-artist">â€”</div>
    <p class="desc" id="r-desc">â€”</p>

    <button id="social-btn">323 instant noodle social</button>

    <!-- Chat -->
    <div id="chat-container" style="display:none;">
      <div class="panel" id="chat-box"></div>
      <input id="chat-input" placeholder="type a messageâ€¦" />
    </div>

    <!-- Console -->
    <div class="panel" id="log"></div>
  </section>

<script>
// --- Auto-generate private room ---
const urlParams = new URLSearchParams(window.location.search);
if (!urlParams.has("room")) {
  const newRoom = Math.random().toString(36).substring(2, 8);
  window.location.href = window.location.pathname + "?room=" + newRoom;
}
const roomId = urlParams.get("room");

// --- Connect to backend ---
const socket = io();
const user = "323-noodle-" + Math.floor(100 + Math.random()*900);
socket.emit("joinRoom", roomId);

// log box
const logEl=document.getElementById("log");
function log(msg){
  const p=document.createElement("p");
  p.textContent=msg;
  logEl.appendChild(p);
  logEl.scrollTop=logEl.scrollHeight;
}

// UI elements
const t=document.getElementById("r-title"),
      a=document.getElementById("r-artist"),
      d=document.getElementById("r-desc"),
      chatBox=document.getElementById("chat-box"),
      input=document.getElementById("chat-input"),
      chatContainer=document.getElementById("chat-container"),
      socialBtn=document.getElementById("social-btn");

// voice player
const voicePlayer = new Audio();
let autoMode = true;     // before chat button
let chatMode = false;    // after chat button
let currentDropText = ""; // remember current drop description

// --- Fetch drop from your backend ---
async function loadDrop(){
  if(!autoMode && !chatMode) return;
  try{
    log("ðŸ“¡ fetching dropâ€¦");
    const r=await fetch("https://three23cosmetics-backend.onrender.com/api/trend",{cache:"no-store"});
    const j=await r.json();

    t.textContent = j.product || "â€”";
    a.textContent = j.brand || "â€”";
    d.textContent = j.description || "â€”";

    if(j.description){
      currentDropText = j.description;
      playVoice(j.description, "drop");
    }
  }catch(e){
    log("âŒ error fetching drop");
  }
}

// --- Play AI voice ---
async function playVoice(text, source="drop"){
  try{
    log(`ðŸŽ¤ ${source} voice loadingâ€¦`);
    const url=`https://three23cosmetics-backend.onrender.com/api/voice?text=${encodeURIComponent(text)}`;
    voicePlayer.src=url;
    await voicePlayer.play();
    log(`ðŸ”Š ${source} playing`);
    voicePlayer.onended=()=>{
      if(source==="drop" && autoMode){
        setTimeout(loadDrop,3000);
      }
      if(source==="chat" && chatMode && currentDropText){
        playVoice(currentDropText, "drop"); // resume drop
      }
    };
  }catch(e){
    log("ðŸ”‡ voice error");
  }
}

// --- Start button ---
document.getElementById("social-btn").addEventListener("click",()=>{
  socialBtn.style.display="none";
  chatContainer.style.display="block";
  chatMode = true;
  autoMode = false; // stop auto-refresh loop
  log(`ðŸœ joined 323 instant noodle social â€” room ${roomId}`);
});

// --- Chat send ---
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && input.value.trim()!==""){
    const text=input.value.trim();
    socket.emit("chatMessage",{roomId,user,text});
    input.value="";
  }
});

// --- Chat receive ---
socket.on("chatMessage",({user,text})=>{
  const msg=document.createElement("div");
  msg.className="chat-msg";
  msg.innerHTML=`<span class="chat-user">${user}:</span> ${text}`;
  chatBox.appendChild(msg);
  chatBox.scrollTop=chatBox.scrollHeight;

  if(chatMode){
    // interrupt drop
    voicePlayer.pause();
    voicePlayer.currentTime=0;
    playVoice(`${user} says ${text}`, "chat");
  }
});

// start app
loadDrop();
</script>
</body>
</html>
