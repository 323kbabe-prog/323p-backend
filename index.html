<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_BASE = window.location.origin;
  const voicePlayer = new Audio();

  const t=document.getElementById("r-title"),
        a=document.getElementById("r-artist"),
        d=document.getElementById("r-desc"),
        g=document.getElementById("r-tags"),
        img=document.getElementById("r-img"),
        fb=document.getElementById("r-fallback"),
        voiceStatus=document.getElementById("voice-status"),
        logEl=document.getElementById("log"),
        overlay=document.getElementById("loading-overlay");

  function ts(){return new Date().toLocaleTimeString([], {hour12:false});}
  function line(msg){const p=document.createElement("p");p.innerHTML=`<span>[${ts()}]</span> ${msg}`;logEl.appendChild(p);logEl.scrollTop=logEl.scrollHeight;}
  function info(m){line(m);}function ok(m){line(m);}function err(m){line(m);}

  function showOverlay(){ overlay.style.display="flex"; overlay.style.opacity="1"; }
  function hideOverlay(){ overlay.style.opacity="0"; setTimeout(()=>overlay.style.display="none",300); }

  async function loadTrend(){
    try{
      info("ðŸ“¡ scanning vibes rn...");
      showOverlay();

      const r=await fetch(`${API_BASE}/api/trend`,{cache:"no-store"});
      const j=await r.json();

      t.textContent = `ðŸ’„âœ¨ ${j.product?.toLowerCase() || "untitled"} ðŸŒ¸ðŸ”¥`;
      a.textContent = `ðŸ‘©â€ðŸŽ¤ðŸ’Ž ${j.brand?.toLowerCase() || "unknown"} ðŸŒðŸ’–`;
      d.textContent = `ðŸ’–ðŸ”¥ðŸ¦‹ ${j.description?.toLowerCase() || ""} âœ¨ðŸŒˆðŸ’…`;

      g.innerHTML=(j.hashtags||[]).slice(0,3).map(x=>
        `<span class="badge">âœ¨${String(x).toLowerCase()}ðŸ”¥</span>`).join("");

      if(j.image){
        img.src=j.image; img.style.display="block"; fb.style.display="none";
        ok("ðŸ–¼ï¸âœ¨ image ready");
      } else {
        img.style.display="none"; fb.style.display="block";
      }

      if(j.description) playVoice(j.description);
    }catch(e){
      err("âŒ fetch floppedâ€¦ retry soon");
    }finally{
      hideOverlay();
    }
  }

  async function playVoice(text){
    try{
      voiceStatus.textContent="ðŸŽ¤ðŸ”Šâœ¨ ai voice loadingâ€¦";
      const url=`${API_BASE}/api/voice?text=${encodeURIComponent(text)}`;
      voicePlayer.src=url;
      await voicePlayer.play();
      ok("ðŸŽ¤ðŸ’– voice playing");
      voicePlayer.onended=()=>{
        voiceStatus.textContent="";
        setTimeout(loadTrend, 3000);
      };
    }catch(e){
      err("ðŸ”‡ðŸ’” voice error");
      voiceStatus.textContent="";
      setTimeout(loadTrend, 3000);
    }
  }

  // âœ… Auto-join random room if ?room=xxxx is in URL
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get("room");
  if (roomId) {
    const socket = io(API_BASE);
    socket.emit("joinRoom", roomId);
    info(`ðŸ”Œ joined room: ${roomId}`);
  }

  document.getElementById("start-btn").addEventListener("click",()=>{
    document.getElementById("start-screen").style.display="none";
    document.getElementById("app").style.display="block";
    loadTrend();
  });
});
</script>
