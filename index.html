<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>323drop ‚Äî gen z vibes</title>
<style>
  body {
    margin:0;
    color:#fff;
    font-family: 'Inter', sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    background: linear-gradient(-45deg, #ff00cc, #3333ff, #00ffee, #ff9900);
    background-size: 400% 400%;
    animation: gradientShift 12s ease infinite;
  }
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  #start-screen {
    display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;
  }
  #start-btn {
    background:linear-gradient(90deg,#00ffcc,#00aaff);
    color:#000;font-size:22px;font-weight:bold;
    padding:16px 32px;border:none;border-radius:30px;cursor:pointer;
    box-shadow:0 0 20px rgba(0,255,204,.5);transition:transform .2s ease;
    text-transform:lowercase;
  }
  #start-btn:hover { transform:scale(1.05); }

  .card {
    background:rgba(20,20,20,0.8);
    border-radius:24px; padding:24px; margin:20px auto; max-width:600px;
    backdrop-filter: blur(10px);
    border:2px solid transparent;
    box-shadow:0 0 25px rgba(0,255,204,.4);
    animation: pulseBorder 3s infinite alternate;
  }

  .title { font-size:26px; font-weight:800; margin:0.3em 0; color:#00ffcc; text-transform:lowercase; }
  .artist { font-size:20px; font-weight:600; opacity:.95; color:#fff; text-transform:lowercase; }

  /* üçú button */
  .social-btn {
    display:inline-block;
    padding:16px 32px;
    background:linear-gradient(90deg,#ff00ff,#00ffff);
    color:#000;
    font-size:18px;
    font-weight:bold;
    text-decoration:none;
    border-radius:30px;
    box-shadow:0 0 15px rgba(255,0,255,.6);
    font-family:'Inter',sans-serif;
    text-transform:lowercase;
    margin:10px 0;
  }
  .social-btn:hover { transform:scale(1.05); }

  .desc { margin:1em 0; font-size:15px; line-height:1.5; color:#eee; text-transform:lowercase; }

  .badge {
    display:inline-block; margin:6px; padding:6px 14px;
    background:linear-gradient(135deg,#ff00ff,#00ffff);
    border-radius:20px; font-size:13px; font-weight:bold; color:#000;
    box-shadow:0 0 20px rgba(255,0,255,.6);
    text-transform:lowercase;
  }

  .fallback {
    color:#aaa; border:2px dashed #333; border-radius:20px; padding:20px; text-align:center;
    font-style:italic; text-transform:lowercase;
  }

  .console {
    font-family:monospace; background:#111; border-radius:16px; padding:12px;
    margin:20px; max-height:200px; overflow:auto;
    border:1px solid #222; box-shadow:inset 0 0 10px rgba(0,255,204,.2);
    font-size:13px; color:#0ff; text-transform:lowercase;
  }

  #loading-overlay {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.9);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:26px;
    font-weight:bold;
    color:#00ffcc;
    z-index:9999;
    opacity:0;
    transition:opacity 0.3s ease;
    text-transform:lowercase;
    pointer-events:none;
  }
  .spinner {
    border:6px solid #222;
    border-top:6px solid #00ffcc;
    border-radius:50%;
    width:60px; height:60px;
    animation:spin 1s linear infinite;
    margin-bottom:20px;
  }
</style>
</head>
<body>
<div id="start-screen">
  <button id="start-btn">üîä tap in w/ voice rn</button>
</div>

<div id="app" style="display:none;width:100%;max-width:700px;">
  <section class="card">
    <div class="title" id="r-title">‚Äî</div>
    <div class="artist" id="r-artist">‚Äî</div>

    <!-- üçú social button -->
    <div style="display:flex; justify-content:center; align-items:center; height:200px;">
      <a id="social-link" class="social-btn" target="_blank">üçú enter 323 instant noodle social</a>
    </div>

    <p class="desc" id="r-desc">‚Äî</p>
    <div id="voice-status"></div>
    <div id="r-tags"></div>
    <div id="r-count"></div>
    <img id="r-img" alt="trend image" style="width:100%;display:none;border-radius:20px;margin-top:12px;" />
    <div id="r-fallback" class="fallback">no image yet</div>
  </section>
  <div class="console" id="log"></div>
</div>

<div id="loading-overlay">
  <div class="spinner"></div>
  323cosmetics searching...
</div>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_BASE = window.location.origin;
  const voicePlayer = new Audio();

  const t=document.getElementById("r-title"),
        a=document.getElementById("r-artist"),
        d=document.getElementById("r-desc"),
        g=document.getElementById("r-tags"),
        img=document.getElementById("r-img"),
        fb=document.getElementById("r-fallback"),
        voiceStatus=document.getElementById("voice-status"),
        logEl=document.getElementById("log"),
        overlay=document.getElementById("loading-overlay");

  function ts(){return new Date().toLocaleTimeString([], {hour12:false});}
  function line(msg){const p=document.createElement("p");p.innerHTML=`<span>[${ts()}]</span> ${msg}`;logEl.appendChild(p);logEl.scrollTop=logEl.scrollHeight;}
  function info(m){line(m);}function ok(m){line(m);}function err(m){line(m);}

  function showOverlay(){ overlay.style.display="flex"; overlay.style.opacity="1"; }
  function hideOverlay(){ overlay.style.opacity="0"; setTimeout(()=>overlay.style.display="none",300); }

  async function loadTrend(){
    try{
      info("üì° scanning vibes rn...");
      showOverlay();

      const r=await fetch(`${API_BASE}/api/trend`,{cache:"no-store"});
      const j=await r.json();

      t.textContent = `üíÑ‚ú® ${j.product?.toLowerCase() || "untitled"} üå∏üî•`;
      a.textContent = `üë©‚Äçüé§üíé ${j.brand?.toLowerCase() || "unknown"} üåçüíñ`;
      d.textContent = `üíñüî•ü¶ã ${j.description?.toLowerCase() || ""} ‚ú®üåàüíÖ`;

      g.innerHTML=(j.hashtags||[]).slice(0,3).map(x=>
        `<span class="badge">‚ú®${String(x).toLowerCase()}üî•</span>`).join("");

      if(j.image){
        img.src=j.image; img.style.display="block"; fb.style.display="none";
        ok("üñºÔ∏è‚ú® image ready");
      } else {
        img.style.display="none"; fb.style.display="block";
      }

      if(j.description) playVoice(j.description);
    }catch(e){
      err("‚ùå fetch flopped‚Ä¶ retry soon");
    }finally{
      hideOverlay();
    }
  }

  async function playVoice(text){
    try{
      voiceStatus.textContent="üé§üîä‚ú® ai voice loading‚Ä¶";
      const url=`${API_BASE}/api/voice?text=${encodeURIComponent(text)}`;
      voicePlayer.src=url;
      await voicePlayer.play();
      ok("üé§üíñ voice playing");
      voicePlayer.onended=()=>{
        voiceStatus.textContent="";
        setTimeout(loadTrend, 3000);
      };
    }catch(e){
      err("üîáüíî voice error");
      voiceStatus.textContent="";
      setTimeout(loadTrend, 3000);
    }
  }

  // ‚úÖ Auto-join room if ?room=xxxx is in URL
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get("room");
  if (roomId) {
    const socket = io(API_BASE);
    socket.emit("joinRoom", roomId);
  }

  // ‚úÖ üçú button generates fresh random room each click
  const socialLink = document.getElementById("social-link");
  if (socialLink) {
    socialLink.addEventListener("click", (e) => {
      e.preventDefault();
      const newRoom = Math.random().toString(36).substring(2, 8);
      const newUrl = `${API_BASE}/?room=${newRoom}`;
      window.open(newUrl, "_blank");
    });
  }

  document.getElementById("start-btn").addEventListener("click",()=>{
    document.getElementById("start-screen").style.display="none";
    document.getElementById("app").style.display="block";
    loadTrend();
  });
});
</script>
</body>
</html>
