<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>323 instant noodle social</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body {
    margin:0;
    font-family:'Inter',sans-serif;
    background: linear-gradient(-45deg,#ff00cc,#3333ff,#00ffee,#ff9900);
    background-size:400% 400%;
    animation:gradientShift 12s ease infinite;
    display:flex;
    flex-direction:column;
    align-items:center;
    color:#fff;
  }
  @keyframes gradientShift {
    0% {background-position:0% 50%}
    50% {background-position:100% 50%}
    100% {background-position:0% 50%}
  }

  /* Feed card styled like base mode */
  .feed-card {
    width:100%;
    max-width:900px;
    margin:40px auto;
    padding:24px;
    border-radius:24px;
    background:rgba(20,20,20,0.85);
    border:2px solid transparent;
    box-shadow:0 0 25px rgba(0,255,204,.4);
    backdrop-filter:blur(10px);
  }

  .title {
    font-size:20px;
    font-weight:700;
    color:#00ffcc;
    margin-bottom:8px;
    text-transform:lowercase;
  }
  .brand {
    font-size:16px;
    font-weight:600;
    color:#fff;
    margin-bottom:12px;
    text-transform:lowercase;
    opacity:.9;
  }
  .desc {
    font-size:15px;
    line-height:1.6;
    color:#eee;
    margin:12px 0;
    text-transform:lowercase;
  }

  #hashtags {margin:12px 0;}
  .badge {
    display:inline-block;
    margin:4px;
    padding:6px 14px;
    background:linear-gradient(135deg,#ff00ff,#00ffff);
    border-radius:20px;
    font-size:13px;
    font-weight:bold;
    color:#000;
    text-transform:lowercase;
    box-shadow:0 0 20px rgba(255,0,255,.6);
  }

  #social-btn {
    background:linear-gradient(90deg,#ff00ff,#00ffff);
    color:#000;
    font-size:14px;
    font-weight:bold;
    padding:8px 16px;
    border:none;
    border-radius:20px;
    cursor:pointer;
    margin-top:12px;
    box-shadow:0 0 15px rgba(255,0,255,.6);
    text-transform:lowercase;
  }

  img.drop-img {
    width:100%;
    border-radius:20px;
    margin-top:12px;
    display:none;
  }

  /* Chat + console panels stacked below */
  #social-panels {
    max-width:900px;
    width:100%;
    margin-bottom:40px;
    display:none;
  }
  .panel {
    font-family:monospace;
    background:#111;
    border-radius:16px;
    padding:12px;
    max-height:200px;
    overflow:auto;
    border:1px solid #222;
    font-size:13px;
    color:#0ff;
    box-sizing:border-box;
    margin-top:20px;
  }
  #chat-input {
    border:none;
    padding:8px;
    margin-top:6px;
    font-size:14px;
    width:100%;
    border-radius:8px;
    outline:none;
  }
  .chat-msg {margin:4px 0;}
  .chat-user {color:#00ffcc; font-weight:bold;}
</style>
</head>
<body>

  <!-- Drop feed card identical to Base Mode -->
  <section class="feed-card">
    <div class="title" id="r-title">‚Äî</div>
    <div class="brand" id="r-artist">‚Äî</div>
    <p class="desc" id="r-desc">‚Äî</p>
    <div id="hashtags"></div>
    <img id="r-img" class="drop-img" alt="trend image" />
    <div id="r-fallback" style="color:#aaa; border:2px dashed #333; border-radius:16px; padding:12px; text-align:center; font-style:italic; margin-top:12px;">
      no image yet
    </div>
    <button id="social-btn">323 instant noodle social</button>
  </section>

  <!-- Social mode panels stacked below -->
  <div id="social-panels">
    <div id="chat-container">
      <div class="panel" id="chat-box"></div>
      <input id="chat-input" placeholder="type a message‚Ä¶" />
    </div>
    <div class="panel" id="log"></div>
  </div>

<script>
// --- Room setup ---
const urlParams = new URLSearchParams(window.location.search);
if (!urlParams.has("room")) {
  const newRoom = Math.random().toString(36).substring(2, 8);
  window.location.href = window.location.pathname + "?room=" + newRoom;
}
const roomId = urlParams.get("room");

// --- Socket.io ---
const socket = io();
const user = "323-noodle-" + Math.floor(100 + Math.random()*900);
socket.emit("joinRoom", roomId);

// --- UI elements ---
const t=document.getElementById("r-title"),
      a=document.getElementById("r-artist"),
      d=document.getElementById("r-desc"),
      hashtags=document.getElementById("hashtags"),
      img=document.getElementById("r-img"),
      fb=document.getElementById("r-fallback"),
      chatBox=document.getElementById("chat-box"),
      input=document.getElementById("chat-input"),
      socialBtn=document.getElementById("social-btn"),
      logEl=document.getElementById("log"),
      socialPanels=document.getElementById("social-panels");

const voicePlayer = new Audio();
let socialMode = false;
let currentDropVoice = "";

// --- Console log helper ---
function log(msg){
  const p=document.createElement("p");
  p.textContent=msg;
  logEl.appendChild(p);
  logEl.scrollTop=logEl.scrollHeight;
}

// --- Load drop ---
async function loadDrop(){
  try{
    log("üì° fetching drop‚Ä¶");
    const r=await fetch(`/api/trend?room=${roomId}`,{cache:"no-store"});
    const j=await r.json();

    t.textContent = j.product || "‚Äî";
    a.textContent = j.brand || "‚Äî";
    d.textContent = j.description || "‚Äî";
    hashtags.innerHTML = (j.hashtags||[]).map(x=>`<span class="badge">${x}</span>`).join("");

    if(j.image){ img.src=j.image; img.style.display="block"; fb.style.display="none"; }
    else { img.style.display="none"; fb.style.display="block"; }

    if(j.voice){
      currentDropVoice = j.voice;
      playVoice(j.voice, "drop");
    }
  }catch(e){
    log("‚ùå error fetching drop");
  }
}

// --- Play voice ---
async function playVoice(voiceData, source="drop"){
  try{
    if(!voiceData) return;
    voicePlayer.src = voiceData;
    await voicePlayer.play();
    log(`üîä ${source} playing`);
    voicePlayer.onended = ()=>{
      if(source !== "drop" && socialMode){
        playVoice(currentDropVoice, "drop");
      }
    };
  }catch(e){
    log("üîá voice error");
  }
}

// --- Enter Social Mode ---
socialBtn.addEventListener("click",()=>{
  socialMode = true;
  socialBtn.style.display="none";
  socialPanels.style.display="block";
  log(`üçú entered 323 instant noodle social ‚Äî room ${roomId}`);
});

// --- Send chat ---
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && input.value.trim()!==""){
    const text=input.value.trim();
    socket.emit("chatMessage",{roomId,user,text});
    input.value="";
  }
});

// --- Chat history (on join) ---
socket.on("chatHistory", (history) => {
  chatBox.innerHTML = "";
  history.forEach(({ user: textUser, text }) => {
    const msg=document.createElement("div");
    msg.className="chat-msg";
    msg.innerHTML=`<span class="chat-user">${textUser}:</span> ${text}`;
    chatBox.appendChild(msg);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
});

// --- Receive chat ---
socket.on("chatMessage",async ({user:textUser,text})=>{
  const msg=document.createElement("div");
  msg.className="chat-msg";
  msg.innerHTML=`<span class="chat-user">${textUser}:</span> ${text}`;
  chatBox.appendChild(msg);
  chatBox.scrollTop=chatBox.scrollHeight;

  if(socialMode){
    voicePlayer.pause();
    voicePlayer.currentTime=0;
    try{
      const r=await fetch(`/api/voice?text=${encodeURIComponent(textUser+" says "+text)}`);
      const blob=await r.blob();
      const voiceData=URL.createObjectURL(blob);
      playVoice(voiceData, "chat");
    }catch(e){
      log("‚ùå chat voice error");
    }
  }
});

// --- Initial load ---
loadDrop();
</script>
</body>
</html>
